name: Build and Deploy

on:
  push:
    branches: [main, develop]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }} # This creates a concurrency group based on the branch name
  cancel-in-progress: true # This cancels any in-progress runs in the same group

# Required permissions for OIDC authentication
permissions:
  id-token: write # Required to request OIDC token
  contents: read # Required to checkout repository
  pull-requests: write # Required to comment on PRs

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.13.5
  PKG_VERSION: 1.14.3
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/kubernetes-stack

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: cd terraform && terraform fmt -check -recursive

      - name: Terraform Init
        run: cd terraform && terraform init -backend=false

      - name: Terraform Validate
        run: cd terraform && terraform validate

  migration-check:
    name: Check Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Build Migration Tool
        run: |
          cd migrations
          go mod download
          go build -o migrate .

      - name: Check Migration Status
        run: ./migrate.sh status

  packer-build:
    name: Build Packer AMI
    runs-on: ubuntu-latest
    needs: [validate, migration-check]
    if: (github.event_name == 'push') || (github.event_name == 'pull_request')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files in the packer folder
        id: check-packer-changes
        uses: tj-actions/changed-files@v47 # v47
        with:
          files: packer/**
          # files_ignore: docs/static.js

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        if: steps.check-packer-changes.outputs.any_changed == 'true'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Packer-${{ github.run_id }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        if: steps.check-packer-changes.outputs.any_changed == 'true'
        with:
          version: ${{ env.PKG_VERSION }}

      - name: Initialize Packer
        if: steps.check-packer-changes.outputs.any_changed == 'true'
        run: |
          cd packer
          packer init minikube.pkr.hcl

      - name: Validate Packer Template
        if: steps.check-packer-changes.outputs.any_changed == 'true'
        run: |
          cd packer
          packer validate minikube.pkr.hcl
        env:
          PKR_VAR_aws_region: ${{ vars.PKR_VAR_aws_region }}
          PKR_VAR_instance_type: ${{ vars.PKR_VAR_instance_type }}
          PKR_VAR_ami_name_prefix: ${{ vars.PKR_VAR_ami_name_prefix }}
          PKR_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Build AMI with Packer
        if: steps.check-packer-changes.outputs.any_changed == 'true'
        run: |
          cd packer
          packer build minikube.pkr.hcl
        env:
          PKR_VAR_aws_region: ${{ vars.PKR_VAR_aws_region }}
          PKR_VAR_instance_type: ${{ vars.PKR_VAR_instance_type }}
          PKR_VAR_ami_name_prefix: ${{ vars.PKR_VAR_ami_name_prefix }}
          PKR_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Upload Packer Manifest
        if: steps.check-packer-changes.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: packer-manifest
          path: packer/packer-manifest.json
          retention-days: 30

  build-and-push:
    name: Docker Build and Push
    needs: [validate, migration-check]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Build and push Production image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Dev image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.dev
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [validate, migration-check, packer-build]
    if: github.event_name == 'pull_request' && (needs.packer-build.result == 'skipped' || needs.packer-build.result == 'success')
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Plan-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Build Migration Tool
        run: make build

      - name: Run Migrations
        run: ./migrate.sh up

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Terraform Plan
        id: plan
        run: cd terraform && terraform plan -no-color -out=tfplan
        continue-on-error: true
        env:
          TF_VAR_aws_region: ${{ vars.TF_VAR_aws_region }}
          TF_VAR_environment: ${{ vars.TF_VAR_environment }}
          TF_VAR_project_name: ${{ vars.TF_VAR_project_name }}
          TF_VAR_vpc_cidr: ${{ vars.TF_VAR_vpc_cidr }}
          TF_VAR_az_count: ${{ vars.TF_VAR_az_count }}
          TF_VAR_enable_nat_gateway: ${{ vars.TF_VAR_enable_nat_gateway }}
          TF_VAR_github_org: ${{ vars.TF_VAR_github_org }}
          TF_VAR_github_repo: ${{ vars.TF_VAR_github_repo }}
          TF_VAR_github_branches: ${{ vars.TF_VAR_github_branches }}
          TF_VAR_enable_remote_state: ${{ vars.TF_VAR_enable_remote_state }}
          TF_VAR_terraform_state_bucket: ${{ vars.TF_VAR_terraform_state_bucket }}
          TF_VAR_github_token: ${{ secrets.TF_VAR_github_token }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Update Pull Request
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan ðŸ“–\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  plan-production:
    name: Terraform Plan (Production)
    runs-on: ubuntu-latest
    needs: [validate, migration-check, packer-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && (needs.packer-build.result == 'skipped' || needs.packer-build.result == 'success')
    outputs:
      has_changes: ${{ steps.check_plan.outputs.has_changes }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Plan-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Build Migration Tool
        run: make build

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Terraform Plan and Capture Exit Code
        id: plan
        run: cd terraform && terraform plan -detailed-exitcode -out=tfplan -no-color
        continue-on-error: true # Allow the step to continue even if it exits with 1 or 2
        env:
          TF_VAR_aws_region: ${{ vars.TF_VAR_aws_region }}
          TF_VAR_environment: ${{ vars.TF_VAR_environment }}
          TF_VAR_project_name: ${{ vars.TF_VAR_project_name }}
          TF_VAR_vpc_cidr: ${{ vars.TF_VAR_vpc_cidr }}
          TF_VAR_az_count: ${{ vars.TF_VAR_az_count }}
          TF_VAR_enable_nat_gateway: ${{ vars.TF_VAR_enable_nat_gateway }}
          TF_VAR_github_org: ${{ vars.TF_VAR_github_org }}
          TF_VAR_github_repo: ${{ vars.TF_VAR_github_repo }}
          TF_VAR_github_branches: ${{ vars.TF_VAR_github_branches }}
          TF_VAR_enable_remote_state: ${{ vars.TF_VAR_enable_remote_state }}
          TF_VAR_terraform_state_bucket: ${{ vars.TF_VAR_terraform_state_bucket }}
          TF_VAR_github_token: ${{ secrets.TF_VAR_github_token }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Check Plan Results
        id: check_plan
        if: steps.plan.outcome == 'success'
        run: |
          # Terraform plan exits with:
          # 0 - No changes
          # 1 - Error
          # 2 - Changes present

          if [ $EXIT_CODE -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

          terraform show -no-color tfplan > plan-output.txt
        env:
          # This environment variable is set by hashicorp/setup-terraform when terraform_wrapper is true
          # and contains the exit code of the wrapped terraform command.
          EXIT_CODE: ${{ steps.plan.outputs.exitcode }}
        working-directory: terraform

      - name: Handle Terraform Plan Errors
        if: steps.plan.outcome == 'failure'
        run: |
          echo "::error::Terraform plan failed (exit code 1)."
          exit 1 # Fail the job if a critical error occurred during planning

      - name: Display Plan Summary
        run: |
          echo "### ðŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**has_changes output:** \`${{ steps.check_plan.outputs.has_changes }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_plan.outputs.has_changes }}" == "false" ]; then
            echo "âœ… **No changes detected** - Apply job will be skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Changes detected** - Apply job will run after approval" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          cat terraform/plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Plan Artifact
        if: steps.check_plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: |
            terraform/tfplan
            terraform/plan-output.txt
          retention-days: 7

  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [plan-production]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.plan-production.outputs.has_changes == 'true'
    # Manual approval required - review plan in previous job before approving
    # Configure at: Settings > Environments > production > Required reviewers
    environment:
      name: production
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Apply-${{ github.run_id }}

      - name: Verify AWS Identity
        run: |
          echo "=== AWS Caller Identity ==="
          aws sts get-caller-identity
          echo ""
          echo "Assumed Role ARN:"
          aws sts get-caller-identity --query Arn --output text

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Build Migration Tool
        run: make build

      - name: Run Migrations
        run: ./migrate.sh up

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: terraform

      - name: Display Plan Being Applied
        run: |
          echo "### ðŸš€ Applying Terraform Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          cat terraform/plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Terraform Apply
        id: apply
        run: cd terraform && terraform apply tfplan
        env:
          TF_VAR_aws_region: ${{ vars.TF_VAR_aws_region }}
          TF_VAR_environment: ${{ vars.TF_VAR_environment }}
          TF_VAR_project_name: ${{ vars.TF_VAR_project_name }}
          TF_VAR_vpc_cidr: ${{ vars.TF_VAR_vpc_cidr }}
          TF_VAR_az_count: ${{ vars.TF_VAR_az_count }}
          TF_VAR_enable_nat_gateway: ${{ vars.TF_VAR_enable_nat_gateway }}
          TF_VAR_github_org: ${{ vars.TF_VAR_github_org }}
          TF_VAR_github_repo: ${{ vars.TF_VAR_github_repo }}
          TF_VAR_github_branches: ${{ vars.TF_VAR_github_branches }}
          TF_VAR_enable_remote_state: ${{ vars.TF_VAR_enable_remote_state }}
          TF_VAR_terraform_state_bucket: ${{ vars.TF_VAR_terraform_state_bucket }}
          TF_VAR_github_token: ${{ secrets.TF_VAR_github_token }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Comment on Commit
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: 'âœ… Terraform applied successfully!'
            })
